<!DOCTYPE html>
<html>
<head>
	<title>ADS-B Receiver Monitor</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
		integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
		crossorigin=""/>
	<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
		integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
		crossorigin=""></script>
	<script src="company_callsigns.js"></script>
	<style>
		a { text-decoration: none; color: inherit; }
		body { background-color: #000000; font: Tahoma, sans-serif, arial; margin: 0px; padding: 0px; }
		h3 { color: #e0e2e3; font-variant: small-caps; padding-top: 1px; margin-top: 0px; padding-bottom: 2px; margin-bottom: 0px; background-image: linear-gradient(#000000,#000091); border-bottom: 1px solid #3030df; border-top: 1px solid #000000; border-left: 1px solid #000000; border-right: 1px #000000; border-radius: 5px; }
		.main-table { margin: 0px; padding: 0px; background: #000000; }
		td.main-left { vertical-align: top; padding: 0px; margin: 0px; background: #00001f; }
		td.main-center { margin: 0px; padding-left: 1px; padding-top: 0px; padding-right: 1px; vertical-align: top; color: yellow; font-size: 0.7em; text-align: left; background: #20203c; border-radius: 3px; }
		td.main-right { vertical-align: top; display: block; padding: 0px; margin: 0px; }
		td.additional-pager { vertical-align: top; padding: 0px; margin: 0px; width: 15px; }
		td.additional-page-left { vertical-align: top; padding: 0px; margin: 0px; }
		td.additional-page-right { display: none; padding: 0px; margin: 0px; }
		#main { text-align: center; vertical-align: top; margin-top: 0px; }
		#mapid { height: 550px; width: 600px; display: block; text-align: center; vertical-align: top; margin: 0px; padding: 0px; border: 2px solid #30307a; border-radius: 3px; }
		div.airports-lists { width: 100%; border: 1px; color: #FFFFFF; display: block; text-align: left; font-size: 0.8em; }
		.leaflet-tooltip { 
			color: #e0ef00; 
			background: rgba(155,155,155,0); 
			font-size: 0.8em; 
			font-variant: small-caps; 
			text-align: left; 
			border: none !important;
			box-shadow: none !important;
		}
		.leafleft-popup-tip-container { 
			display: none;
			width: 0px;
			height: 0px;
		}
		.leafleft-tooltip-right:before { 
			background: transparent;
			border: none;
			box-shadow: none;
		}
		.alti-bar-header { 
			background: #404012; border: 1px solid #505012; border-radius: 3px; border-radius-bottom: 0px;
		}
		#alti-bar {
			border: 1px solid #505004; padding-left: 5px; padding-right: 2px; height: 518px; border-radius: 5px; border-top-left-radius: 0px; border-top-right-radius: 0px; background: #000013; margin: 0px;
		}
		div.info-div { text-align: left; vertical-align: top; color: #ffffff; font: sans-serif; padding-left: 2px; margin: 0px; }
		table.stats-list { color: #ffffff; font-size: 0.8em; vertical-align: top; width: 580px; border: 2px groove #307072; margin-bottom: 5px; border-radius: 5px; padding: 0px; }
		.stats-list-head th { text-align: center; background: #90E0E1; color: #000000; font-size: 0.8em; }
		.stats-list-body { }
		.stats-list-footer td { text-align: center; background: #205051; color: #FFFFFF;  font-size: 0.8em; }
		div.filter-place { margin-left: 1px; background-color: #204041; border: 1px solid #709091; border-radius: 3px; padding-left: 4px; padding-top: 1px; padding-bottom: 1px; }
		span.filters { 
			font-size: 0.7em; 
			padding-top: 3px;
			padding-bottom: 0px;
			display: grid;
			grid-template-columns: 80px 80px 100px 125px 100px 80px;
			grid-gap: 0;
			margin: 0;
		}
		.form-control:nth-child(n+7){
			padding-top: 5px;
			border-top: 1px solid #707590;
		}
		.form-control:nth-child(4){
			padding-top: 5px;
			border-right: 1px solid #707590;
		}
		.form-control:nth-child(10){
			padding-top: 5px;
			border-right: 1px solid #707590;
		}
		.btn-reset-map { 
			border: 0px; background-color: #10101A; color: #F0202F; font-size: 1.0em; margin-right: 1px; border-radius: 1px; margin-bottom: 1px; font: sans-serif; width: 70px height: 25px; 
		}
		table.ac-list { color: #ffffff; font-size: 0.8em; border: 1px solid #000000; vertical-align: top; width: 580px; cursor: pointer; margin-top: 5px;  border-radius: 5px; }
		.ac-list-head th { text-align: center; background: #208081; color: #FFFFFF;  font-size: 0.8em; padding: 2px; }
		.ac-list-footer td { text-align: center; background: #505021; color: #FFFFFF;  font-size: 0.8em; }
		div.flight-director { border: 2px groove #60607E; border-radius: 6px; background: black; display: none; width: 458px; height: 400px; margin-left: 100px; padding-left: 2px;
			position: absolute; z-index: 10000; top: 100px;
		}
		canvas.fd-canvas-style { display: none; z-index: 10001; }
		.owm-opacity { -webkit-appearance: none; height: 8px; width: 90px; background: #101120; margin-left: 6px; margin-top: 7px; outline-style: ridge; outline-color: #555556; outline-width: 2px; border: 1px solid #404041; padding-top: 4px;} 
		.owm-opacity::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; height: 10px; width: 10px;  cursor: pointer; background: #202140; outline-color: #FFFFFF; outline-style: groove; outline-width: 2px; } 
		.owm-opacity::-moz-range-thumb { height: 10px; width: 10px; cursor: pointer; background: #202140; outline-color: #FFFFFF; outline-style: groove; outline-width: 2px;} 
		table.runway-list {
			color: #ffffff; font-size: 0.8em; vertical-align: top; width: 600px; table-layout: fixed;
		}
		.runway-list-header th { text-align: center; background: #70C0C1; color: #000000; font-size: 0.8em; }
		.runway-list-body { text-align: center; }

		.form-control {
			font-family: system-ui, sans-serif;
			font-size: inherit;
			line-height: 0.8;
			padding-left: 3px;
			padding-right: 2px;
			padding-bottom: 3px;
		}
		input[type="button"] {
			-moz-appearance: none;
			-webkit-appearance: none;
			appearance: none;
			background-color: #000;
			margin: 0;
			vertical-align: middle;
			font: inherit;
			font-family: monospace;
			font-size: 10px;
			/* color: currentColor; */
			width: 7.3em;
			height: 3.05em;
			border: 0.25em solid #335;
			border-radius: 0.35em;
			transform: translateY(-0.075em);
		}
		input[type="button"]:active {
			transform: scale(1);
			background-color: #900;
			color: #fff;
			transform-origin: bottom left;
			transition: 120ms transform ease-in-out;
			box-shadow: inset 1em 1em var(--form-control-color);
			/* clip-path: polygon(90% 90% 90%); */
		}
		input[type="checkbox"] {
			-moz-appearance: none;
			-webkit-appearance: none;
			appearance: none;
			background-color: #000;
			margin: 0;
			vertical-align: middle;
			font: inherit;
			font-family: monospace;
			font-size: 10px;
			/* color: currentColor; */
			width: 3.05em;
			height: 3.05em;
			border: 0.25em solid #335;
			border-radius: 0.15em;
			transform: translateY(-0.075em);
		}
		input[type="checkbox"]::before {
			/* content: '';*/
			font-family: monospace;
			font-size: 10px;
			content: 'OFF';
			color: #fff;
			position: relative;
			top: 5px;
			left: 5px;
			width: 0.65em;
			height: 0.65em;
			transform: scale(0);
			transition: 120ms transform ease-in-out;
			box-shadow: inset 1em 1em var(--form-control-color);
			background-color: #112;
		}
		input[type="checkbox"]:checked:before {
			content: '';
			transform: scale(1);
			background-color: #330;
			transform-origin: bottom left;
			/* clip-path: polygon(90% 90% 90%); */
		}
		input[type="checkbox"]:checked {
			content: attr(cb-text);
			transform: scale(1);
			background-color: #112;
			color: #fff;
			transform-origin: bottom left;
			outline: max(1px, 0.10em) solid #555;
			/* clip-path: polygon(90% 90% 90%); */
		}
		input[type="checkbox"]:checked:after {
			content: attr(cb-text);
			position: relative;
			top: 15px;
			left: 5px;
			transform: scale(1);
			color: #0f0;
			transform-origin: bottom left;
			/* clip-path: polygon(90% 90% 90%); */
		}
		input[type="checkbox"].cb-map:checked:after {
			content: attr(cb-text);
			position: relative;
			top: 15px;
			left: 5px;
			transform: scale(1);
			background-color: #000;
			color: #ff0 !important;
			transform-origin: bottom left;
			/* clip-path: polygon(90% 90% 90%); */
		}
		input[type="checkbox"].runways-cb:checked:after {
			content: attr(cb-text);
			position: relative;
			top: 15px;
			left: 5px;
			transform: scale(1);
			background-color: #000;
			color: #33f !important;
			transform-origin: bottom left;
			/* clip-path: polygon(90% 90% 90%); */
		}
		input[type="checkbox"]:focus {
			outline: max(1px, 0.10em) solid #557;
			/* outline-offset: max(1px,0.10em); */
			outline-offset: 0px;
		}
		.ecam-display-place{
			text-align: center;
			width: 574px;
			margin-left: 1px; background-color: #204041; border: 1px solid #709091; border-radius: 3px; padding-left: 4px; padding-top: 2px; padding-bottom: 2px; 
		}
		input[type="text"].ecam-warm-display{
			width: 80%; height: 30px;
			background-color: #000;
			color: #0f0;
			border: 2px groove #404041;
			border-radius: 6px;
			margin-bottom: 1px;
		}
		.map-distance{
			height: 18px;
			width: 118px;
			border: 1px solid #404041;
			border-radius: 6px;
			background: #000;
			color: #0F0;
			padding-top: 9px;
			text-align: center;			
		}

		.receiver-circular-info-div {
			margin-left: 1px; background-color: #204041; border: 1px solid #709091; border-radius: 3px; padding-top: 1px; padding-bottom: 1px;
		}
		canvas.receiver-circular-canvas {
			border: 1px solid #506084; padding: 5px; height: 300px; width: 300px; border-radius: 5px; border-top-left-radius: 0px; border-top-right-radius: 0px; background: #000013; margin: 5px;
		}

	</style>
</head>
<body>
<div id="main">
	<h3>ADS-B Receiver Monitor</h3>
	<table class="main-table"><tr>
		<td class="main-left">
			<div class="flight-director" id="fd">
				<canvas class="fd-canvas-style" id="fd-canvas" height="400" width="460"></canvas>
			</div>
			<div id="mapid"></div>
			<div id="airports" class="airports-lists">
				<table id="runways" class="runway-list" cellspacing="0">
					<thead id="runways-head" class="runway-list-header"></thead>
					<tbody id="runways-body" class="runway-list-body"></tbody>
				</table>				
			</div>
		</td>
		<td class="main-center">
			<div class="alti-bar-header">
				<span style="padding-left: 13px;">FL</span><span style="padding-left: 33px;">Alt</span><span style="padding-left: 15px;">Flight</span>
			</div>
			<canvas id="alti-bar" height="500" width="130" class="alti-bar"></canvas>
		</td>
		<td class="main-right">
			<div id="info" class="info-div">
        			<table id="stats" class="stats-list" cellspacing="0">
        				<thead id="stats-head" class="stats-list-head"></thead>
        				<tbody id="stats-body" class="stats-list-body"></tbody>
        				<tfoot id="stats-footer" class="stats-list-footer"></tfoot>
        			</table>
					<div class="ecam-display-place">
						<input type="text" class="ecam-warm-display" id="ecam-display" readonly>
					</div>
        			<div class="filter-place">
        			<span id="filter-checkboxes" class="filters">
						<label class="form-control">
							<input type="button" id="btn-reset-map-pos" class="btn-reset-map" onClick="resetMapPosition()" value="Reset Map">
						</label>
						<label class="form-control">
							<input type="checkbox" id="cb-FD-enabled" onClick="switchFD()" value="FD"> VirtFD
						</label>
						<label class="form-control">
							<input type="checkbox" id="cb-filter-map" onClick="checkFilters()" value="MAP" class="cb-map"> Only map
						</label>
						<label class="form-control">
							<div class="map-distance">
						 		<span id="cb-filter-map-distance">---</span> km / <span id="cb-filter-map-distance-miles">---</span> nmi
						 	</div>
						</label>
						<label class="form-control" id="airports-cb" value="RWYS">
						</label>						
						<label class="form-control">
							<input type="checkbox" value="inop"> INOP
						</label>
					</span>
					</div>
        			<table id="aircrafts" class="ac-list" cellspacing="0">
        				<thead id="aircrafts-head" class="ac-list-head"></thead>
        				<tbody id="aircrafts-body" class="ac-list-body"></tbody>
        				<tfoot id="aircrafts-footer" class="ac-list-footer"></tfoot>
        			</table>
			</div>
		</td>
		<td class="additional-pager">
		</td>
		<td class="additional-page-left">
			<div id="receiver-circular-info" class="receiver-circular-info-div">
				<canvas id="receiver-circular-canvas" height="300" width="300" class="receiver-circular-canvas"></canvas>
			</div>
			<div id="receiver-altitude-info" class="receiver-altitude-info-div">
			</div>
		</td>
	</tr></table>
</div>
<script>
	// Originally written by Juho Einiö 2021
	// Just enter your own receiver domain, location and MapBox (public) access token
	// Known issues (among lots of others; this UI has been done a very quick and very dirty):
	// 2021 Oct 26th 	- FD pitch calculation unfinished & wrong
	//					- Clicking callsign / locking FD to one aircraft freezees FD
	//					- FD altitude "roller" doesn't work correctly yet
	//					- scroll of the aircraft table needs to be done - if the list is growing bigger, every update returns to top
	// 2021 Oct 30th	- Cleaned up the aircraft table a bit, still some work to do with it. Might help with the scrolling also.
	//					- Also cleaned up a bit the ali-bar graph.
	//					- Added feature: filtering by the visible map (using lateral distance of map)
	// 2021 Oct 31st	- Added feature: secondary supplementary receiver appends information the primary receiver has
	//					- still to be done: secondary receiver only aircraft are not displayed
	//					- Added totals to stats, secondary receiver red circle and ac seen older than 1 min with red overstrike
	// 2021 Nov 1st		- Added FD enable/disable checkbox, extended the list of callsigns
	//					- Added ATC call phrases to title element of callsign and squawk
	//					- Added openweathermap.org functionality for winds, clouds and rain + opacity slider for it
	//					- some appearance changes
	// 2021 Nov 2nd		- Added airports (credits for list to ourairports.com - see ourairports.com/data for more lists)

	var receiver_domain = "192.168.11.9"; // change to primary ADS-B receiver host IP or domainname
	var receiver_lat = 61.0, receiver_lon = 26.0; // change to primary ADS-B receiver location
	var receiver_label = "W"; // change to primary ADS-B receiver label (one character works best)
	var second_receiver_enabled = true; // change this to false, if only one receiver is used
	var second_receiver_domain = "192.168.11.18"; // change to supplementary ADS-B receiver host IP or domainname
	var second_receiver_lat = 61.1, second_receiver_lon = 26.1; // change to supplementary ADS-B receiver location
	var second_receiver_label = "E"; // change to supplementary ADS-B receiver label (one character works best)
	var mapbox_accessToken = "<insert_your_mapbox_public_access_token_here>"; // open an account in Mapbox and place the access token here
	var aircraft_refresh_rate = 2000; // Aircraft json fetch frequency - 1000ms
	var stats_refresh_rate = 3000; // dump1090-fa statistics refresh rate
	var openweathermap_wind_enabled = true; // if you don't want to have openweathermap layers, set these to false 
	var openweathermap_clouds_enabled = true;
	var openweathermap_rain_enabled = true;
	var openweathermap_apikey = "<insert_your_openweathermap_org_api_key_here>"; // open an account in openweathermap.org and place your api key here
	var map_complete_refresh_rate = 15*(60*1000); // to refresh the OWM layers
	var airports_enabled = true;
	var airport_aircraft_refresh_rate = 10*1000; // refresh airport aircrafts every 10 seconds

	var mymap = L.map('mapid').setView([receiver_lat, receiver_lon], 6);
	L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
    		attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
    		maxZoom: 18,
    		id: 'mapbox/dark-v8', /* mapbox/streets-v11 */
    		tileSize: 512,
    		zoomOffset: -1,
    		accessToken: mapbox_accessToken
	}).addTo(mymap);

	mymap.on('zoomend', function() {
		filters_map_center = mymap.getCenter();
		filters_map_distance = Math.floor(filters_map_center.distanceTo(L.latLng(filters_map_center.lat, mymap.getBounds().getEast()))/1000);  
		document.getElementById("cb-filter-map-distance").innerHTML = filters_map_distance;
		document.getElementById("cb-filter-map-distance-miles").innerHTML = Math.floor(filters_map_distance * 0.539957); // nautical miles
	});

	function goToMapPoint(lat, lon, zoom){
		mymap.flyTo([lat,lon],zoom);
		window.scrollTo(0,0);
	}

	function resetMapPosition(){
		mymap.flyTo([receiver_lat, receiver_lon], 6);
	}

	// check check box content
	function setCBDefaultValues(){
		document.getElementById("cb-FD-enabled").setAttribute('cb-text','VFD');
		if(airports_enabled)document.getElementById("airports-enabled").setAttribute('cb-text','RWY');
		document.getElementById("cb-filter-map").setAttribute('cb-text','MAP');
		if(openweathermap_wind_enabled)document.getElementById("owm-wind-checkbox").setAttribute('cb-text','WND');
		if(openweathermap_clouds_enabled)document.getElementById("owm-clouds-checkbox").setAttribute('cb-text','CLD');
		if(openweathermap_rain_enabled)document.getElementById("owm-rain-checkbox").setAttribute('cb-text','RAN');
	}
	var initCBtimer = setTimeout(setCBDefaultValues,1000);
	document.getElementById("ecam-display").value = "";

	// Open weather layers to the map
	if(openweathermap_wind_enabled){
		var layer_wind = L.tileLayer("https://tile.openweathermap.org/map/wind_new/{z}/{x}/{y}.png?appid=" + openweathermap_apikey);
		//layer_wind.addTo(mymap);
		document.getElementById("filter-checkboxes").innerHTML += "<label class='form-control'><input type='checkbox' id='owm-wind-checkbox' onclick='owmChange()'> Winds</label>";
	} else { 
		document.getElementById("ecam-display").value += "  WX WIND INOP"; 
		document.getElementById("filter-checkboxes").innerHTML += "<label class='form-control'><input type='checkbox' id='owm-wind-checkbox' disabled> Winds</label>";
		document.getElementById("owm-wind-checkbox").setAttribute('cb-text','');
	}
	if(openweathermap_clouds_enabled){
		var layer_clouds = L.tileLayer("https://tile.openweathermap.org/map/clouds_new/{z}/{x}/{y}.png?appid=" + openweathermap_apikey);
		//layer_clouds.addTo(mymap);
		document.getElementById("filter-checkboxes").innerHTML += "<label class='form-control'><input type='checkbox' id='owm-clouds-checkbox' onclick='owmChange()'> Clouds</label>";
	} else { 
		document.getElementById("ecam-display").value += "  WX CLOUDS INOP"; 
		document.getElementById("filter-checkboxes").innerHTML += "<label class='form-control'><input type='checkbox' id='owm-clouds-checkbox' disabled> Clouds</label>";
		document.getElementById("owm-clouds-checkbox").setAttribute('cb-text','');
	}
	if(openweathermap_rain_enabled){
		var layer_rain = L.tileLayer("https://tile.openweathermap.org/map/precipitation_new/{z}/{x}/{y}.png?appid=" + openweathermap_apikey);
		//layer_rain.addTo(mymap);
		document.getElementById("filter-checkboxes").innerHTML += "<label class='form-control'><input type='checkbox' id='owm-rain-checkbox' onclick='owmChange()'> Rain</label>";		
	} else { 
		document.getElementById("ecam-display").value += "  WX RAIN INOP"; 
		document.getElementById("filter-checkboxes").innerHTML += "<label class='form-control'><input type='checkbox' id='owm-rain-checkbox' disabled> Rain</label>";		
		document.getElementById("owm-rain-checkbox").setAttribute('cb-text','');
	}
	if(openweathermap_rain_enabled || openweathermap_clouds_enabled || openweathermap_wind_enabled){
			document.getElementById("filter-checkboxes").innerHTML += "<label class='form-control'><input type='range' min='1' max='100' value='100' step='1' id='owm-opacity-slider' class='owm-opacity' onclick='owmOpacityChange()'></label>";
			owmOpacityChange(); 
	} else {
			document.getElementById("filter-checkboxes").innerHTML += "<label class='form-control'><input type='range' min='1' max='100' value='100' step='1' id='owm-opacity-slider' class='owm-opacity' disabled></label>";		
	}
	if(layer_wind){
		layer_wind.on('tileerror', function() {
			document.getElementById("ecam-display").value += "  WX WIND FAIL"; 			
		});
		layer_wind.on('load', function() {
			document.getElementById("ecam-display").value.replace("  WX WIND FAIL",""); 
		});
	}
	if(layer_clouds){
		layer_clouds.on('tileerror', function() {
			document.getElementById("ecam-display").value += "  WX CLOUDS FAIL"; 			
		});
		layer_clouds.on('load', function() {
			document.getElementById("ecam-display").value.replace("  WX CLOUDS FAIL",""); 
		});
	}
	if(layer_rain){
		layer_rain.on('tileerror', function() {
			document.getElementById("ecam-display").value += "  WX RAIN FAIL"; 			
		});
		layer_rain.on('load', function() {
			document.getElementById("ecam-display").value.replace("  WX RAIN FAIL",""); 
		});
	}
	function owmChange(){
		if(!document.getElementById("owm-wind-checkbox").checked){
			layer_wind.removeFrom(mymap); 
		} else { 
			layer_wind.addTo(mymap);
		} 
		if(!document.getElementById("owm-clouds-checkbox").checked){
			layer_clouds.removeFrom(mymap); 
		} else { 
			layer_clouds.addTo(mymap);
		} 
		if(!document.getElementById("owm-rain-checkbox").checked){
			layer_rain.removeFrom(mymap); 
		} else { 
			layer_rain.addTo(mymap);
		} 
	}
	var owm_selected_opacity = 1;
	function owmOpacityChange(){
		owm_selected_opacity = (document.getElementById("owm-opacity-slider").value / 100);
		if(openweathermap_wind_enabled)layer_wind.setOpacity(owm_selected_opacity);
		if(openweathermap_rain_enabled)layer_rain.setOpacity(owm_selected_opacity);
		if(openweathermap_clouds_enabled)layer_clouds.setOpacity(owm_selected_opacity);
	}
	function refreshMap(){
		// In order to refresh OWM layers, the whole map should be refreshed. This, of course, will generate more calls to both OSM and OWM.
		// Also, it might cause sort of a flickering (due to redraw). So this should not be called too often. Once in 15 minutes or so?
		mymap._onResize();
		//console.log("Map refreshed");
	}
	var mapRefreshTimer = setInterval(refreshMap, map_complete_refresh_rate);

	// Utils
	function drawLine(ctx,begin,end,stroke='white',width=1){
		if(stroke) ctx.strokeStyle=stroke;
		if(width) ctx.lineWidth=width;
		ctx.beginPath();
		ctx.moveTo(...begin);
		ctx.lineTo(...end);
		ctx.closePath();
		ctx.stroke();
	}

	function deg2rad(degrees){ return( degrees * (Math.PI/180)); }

	function getDistanceFromLatLonInKm(latitude1,longitude1,latitude2,longitude2,units) {
  		var earthRadius = 6371; // Radius of the earth in km
  		var dLat = deg2rad(latitude2-latitude1);  // deg2rad below
  		var dLon = deg2rad(longitude2-longitude1); 
  		var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(deg2rad(latitude1)) * Math.cos(deg2rad(latitude2)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
  		var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
  		var d = earthRadius * c; 
  		var miles = d / 1.609344; 

		if ( units == 'km' ) {  
			return d; 
		} else {
			return miles; 
		}
	}
	
	function toRad(angle) { return angle * Math.PI / 180; }
	function toDeg(angle) { return angle * 180 / Math.PI; }

	var nextpoint_lat = 0, nextpoint_lon = 0;
	function calcNextPoint(lat, lon, brng, dist){
  		dist = dist / 6371;  
   		brng = toRad(brng);  

   		var lat1 = toRad(lat), lon1 = toRad(lon);

   		var lat2 = Math.asin(Math.sin(lat1) * Math.cos(dist) + Math.cos(lat1) * Math.sin(dist) * Math.cos(brng));

   		var lon2 = lon1 + Math.atan2(Math.sin(brng) * Math.sin(dist) *Math.cos(lat1), Math.cos(dist) - Math.sin(lat1) * Math.sin(lat2));

   		if (isNaN(lat2) || isNaN(lon2)) return false;

   		nextpoint_lat = toDeg(lat2);
   		nextpoint_lon = toDeg(lon2);
   		return true;
	}

	// Calculate angle between two positions - return (true) degrees  
	function getAngleBetweenTwoLatLon(alat,alon,blat,blon){ 
		var angle = (Math.atan2((blon-alon),(blat-alat))*180/Math.PI);
		if( angle < 0 ) angle = 360 + angle;
		return angle; 
	}

	function sortTable(tbl,col,ascending,numeric) {
		var table, rows, switching, i, x, y, shouldSwitch;
		table = document.getElementById(tbl);
		switching = true;
		while (switching) {
			switching = false;
			rows = table.rows;
			for (i = 1; i < (rows.length - 1); i++) {
				shouldSwitch = false;
				x = rows[i].getElementsByTagName("TD")[col];
				y = rows[i + 1].getElementsByTagName("TD")[col];
				if(!numeric){ // characters
					if(ascending){
						if (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) {
							shouldSwitch = true;
							break;
						}
					} else {
						if (x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase()) {
							shouldSwitch = true;
							break;
						}					
					}
				} else { // numeric values
					if(ascending){
						if (parseInt(x.innerHTML) > parseInt(y.innerHTML)) {
							shouldSwitch = true;
							break;
						}
					} else {
						if (parseInt(x.innerHTML) < parseInt(y.innerHTML)) {
							shouldSwitch = true;
							break;
						}					
					}					
				}
			}
			if (shouldSwitch) {
				if(ascending){
					rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
				} else { // descending doesn't work yet!
					rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);					
				}
				switching = true;
			}
		}
	}

	function debugTable() {
		var al = document.getElementById("aircrafts-body");
		var outHTML = "";
		for(i=0; i<60; i++) {
			// just add empty lines to aircraft list for scroll issues resolving
			outHTML += "<tr>";
			outHTML += "<td>testA." + i + "</td>" + "<td colspan='10'>T" + i + "</td>";
			outHTML += "</tr>";
		}
		al.innerHTML += outHTML;
	}

	// Alti-box
	const canvas = document.querySelector("#alti-bar");
	function drawAltiBox(){
        	if(canvas.getContext){
				const ctx = canvas.getContext("2d");
				// draw altimeter box
				ctx.clearRect(0,0,canvas.width,canvas.height);
				drawLine(ctx,[55,0],[55,500],'yellow',1);
				drawLine(ctx,[55,500],[70,500],'yellow',1);
				drawLine(ctx,[70,500],[70,0],'yellow',1);
				drawLine(ctx,[70,0],[55,0],'yellow',1);
				ctx.fillStyle = "#303072";
				ctx.font = "small-caps normal 9px sans-serif";
				ctx.fillRect(56,474,13,24);
				ctx.strokeText("3000",0,474);
				ctx.strokeText("FL100",0,405);
				ctx.strokeText("FL200",0,304);
				ctx.strokeText("FL300",0,204);
				ctx.strokeText("FL400",0,104);
       		}
	}

	// Filters
	var filters_map_checked = false;
	var filters_map_center;
	var filters_map_distance = -1; // in meters (center to eastest part of the map)
	function checkFilters(){
		if( document.getElementById("cb-filter-map").checked ){
			filters_map_center = mymap.getCenter();
			filters_map_distance = Math.floor(filters_map_center.distanceTo(L.latLng(filters_map_center.lat, mymap.getBounds().getEast()))/1000);
			document.getElementById("cb-filter-map-distance").innerHTML = filters_map_distance; // kilometers
			document.getElementById("cb-filter-map-distance-miles").innerHTML = Math.floor(filters_map_distance * 0.539957); // nautical miles
			filters_map_checked = true; 
		} else {
			filters_map_checked = false;	
		}
	}

	// Fligth director
	var FDtimer;
	var FD_enabled = true;
	var FD_flight = "", FD_effective_flight = "";
	var FD_locked_flight = "";
	var FD_altitude=-1, FD_rate=0, FD_track=-1, FD_tas=-1, FD_gs=-1, FD_mach =-1;
	var FD_roll = 0, FD_yaw = 0, FD_nav_altitude = 0, FD_nav_heading = 0, FD_nav_qnh = 0;

	function switchFD(){
		if(FD_enabled) FD_enabled = false; else FD_enabled = true;
	}

	function showFD(flight){
		if(!document.getElementById("cb-FD-enabled").checked){
			return;
		}
		if(!FD_locked_flight)FD_flight = flight;		
		if(FD_flight=="")return;
		document.getElementById("fd").style.display = "block";
		document.getElementById("fd-canvas").style.display = "inline-block";
		drawFD();
		FDtimer = setInterval(drawFD, 1000);
	}

	const fd_canvas = document.querySelector("#fd-canvas");
	fd_canvas.addEventListener("click", onclickFD, false);

	function drawFD(){
		//if(FD_flight=="" && FD_locked_flight=="")return;
		// draw template
		const fd_ctx = fd_canvas.getContext("2d");
		// -- erase canvas
		fd_ctx.clearRect(0,0,fd_canvas.width,fd_canvas.height);
		// -- draw flight callsign
		fd_ctx.strokeStyle = "blue";
		fd_ctx.font = "small-caps normal 10px sans-serif";
        fd_ctx.strokeText(FD_effective_flight,1,10);

		// -- close button
		if( FD_locked_flight ){
			fd_ctx.strokeStyle = "lightgray";
			fd_ctx.rect(440,5,10,10);
			fd_ctx.stroke();
			fd_ctx.strokeStyle = "white";
			fd_ctx.beginPath();
			fd_ctx.moveTo(441,6); fd_ctx.lineTo(449,14);
			fd_ctx.moveTo(449,6); fd_ctx.lineTo(441,14);
			fd_ctx.closePath();
			fd_ctx.stroke();
		}

		// -- draw FD artificial horizon
		fd_ctx.fillStyle = "#AFAFFF";
		fd_ctx.strokeStyle = "white";
		fd_ctx.beginPath();
		fd_ctx.moveTo(60,80);
		fd_ctx.quadraticCurveTo(60,40,100,40);
		fd_ctx.lineTo(300,40);
		fd_ctx.quadraticCurveTo(340,40,340,80);
		fd_ctx.lineTo(340,320);
		fd_ctx.quadraticCurveTo(340,360,300,360);
		fd_ctx.lineTo(100,360);
		fd_ctx.quadraticCurveTo(60,360,60,320);
		fd_ctx.lineTo(60,80);
		fd_ctx.closePath();
		fd_ctx.fill();

		// -- roll & pitch
		fd_ctx.fillStyle = "#D2691E";
		fd_ctx.strokeStyle = "#A52A2A";
		fd_ctx.beginPath();
		// define x1 and x2, calc x2 and y2
		const center_x1 = 60, center_y1 = 210, center_len = (340-60);
		//var calc_x2 = center_x1 + Math.cos(Math.PI * FD_roll / 180) * center_len;
		var calc_y2 = center_y1 + Math.sin(Math.PI * FD_roll / 180) * center_len; 
		//var actual_x1 = center_x1 + ((calc_x2-center_x1)/2);
		var actual_y1 = center_y1 + ((calc_y2-center_y1)/2);
		var actual_y2 = center_y1 - ((calc_y2-center_y1)/2);

		// pitch factors to y
		// angle = rate by distance in feet / minute 
		var pitch_angle_rad = 0, pitch_angle_deg = 0, pitch_factor_y = 0;
		var distance_in_feet = -FD_gs * 101.269; // feet per minute = knots * 101.269
		if(FD_rate != "0")pitch_angle_rad = Math.atan(FD_rate/distance_in_feet);
		/*
		if(pitch_angle_rad > 0)pitch_angle_deg = 90-pitch_angle_rad * (180 / Math.PI);
		if(pitch_angle_rad < 0)pitch_angle_deg = pitch_angle_rad * (180 / Math.PI)-90;
		*/
		pitch_angle_deg = pitch_angle_rad * (180 / Math.PI);
		//console.log("pitch angle (deg): " + (-pitch_angle_deg));
		pitch_factor_y = pitch_angle_rad*20;

		fd_ctx.moveTo(center_x1,(actual_y1+pitch_factor_y));
		fd_ctx.lineTo(center_x1+center_len,(actual_y2+pitch_factor_y));

		fd_ctx.lineTo(340,320);
		fd_ctx.quadraticCurveTo(340,360,300,360);
		fd_ctx.lineTo(100,360);
		fd_ctx.quadraticCurveTo(60,360,60,320);
		fd_ctx.lineTo(60,actual_y1);

		fd_ctx.closePath();
		fd_ctx.fill();

		drawLine(fd_ctx,[center_x1,(actual_y1+pitch_factor_y)],[center_x1+center_len,(actual_y2+pitch_factor_y)],"white",1);

		// -- "crosshairs"
		fd_ctx.fillStyle = "#000000";
		fd_ctx.strokeStyle = "white";
		fd_ctx.strokeRect(center_x1+20,center_y1-5,((center_len/2)-60),10);
		fd_ctx.strokeRect((center_x1+(center_len/2)+40),center_y1-5,((center_len/2)-60),10);
		fd_ctx.strokeRect((center_x1+(center_len/2)+40),center_y1-5,10,30);
		fd_ctx.strokeRect(center_x1+20+((center_len/2)-70),center_y1-5,10,30);
		fd_ctx.fillRect(center_x1+20,center_y1-5,((center_len/2)-60),10);
		fd_ctx.fillRect((center_x1+(center_len/2)+40),center_y1-5,((center_len/2)-60),10);
		fd_ctx.fillRect((center_x1+(center_len/2)+40),center_y1-5,10,30);
		fd_ctx.fillRect(center_x1+20+((center_len/2)-70),center_y1-5,10,30);

		// -- speed indicator
		fd_ctx.fillStyle = "#303032";
		fd_ctx.fillRect(2,40,35,320);
		fd_ctx.strokeStyle = "white";
		fd_ctx.fillStyle = "white";
		fd_ctx.font = "small-caps normal 10px sans-serif";
		// scale
		for(sdown=-40; sdown<=40; sdown++){
			if((FD_tas-sdown)<0)continue;
			if(((FD_tas-sdown)%10)==0){
				fd_ctx.beginPath();
				fd_ctx.moveTo(35,center_y1+sdown*3);
				fd_ctx.lineTo(32,center_y1+sdown*3);
				fd_ctx.closePath();
				fd_ctx.stroke();
				if((sdown%2)==0) fd_ctx.fillText(FD_tas-sdown, 10,center_y1+(sdown*3)+4);
			}
		}
		fd_ctx.strokeStyle = "white";
		fd_ctx.fillStyle = "#000000";
		fd_ctx.fillRect(3,195,32,20);		
		fd_ctx.strokeRect(3,195,32,20);		
		fd_ctx.font = "small-caps normal 14px sans-serif";
		fd_ctx.strokeStyle = "white";
		fd_ctx.fillStyle = "white";
		if(FD_tas > 0)fd_ctx.fillText(FD_tas,5,210);
		//fd.ctx.rect(3,180,32,200);
		//fd.ctx.stroke();
		fd_ctx.font = "small-caps normal 12px sans-serif";

		// -- ground speed
		if(FD_gs > 0)fd_ctx.fillText("GS " + Math.floor(FD_gs),5,380);

		// -- altimeter
		fd_ctx.fillStyle = "#303032";
		fd_ctx.fillRect(360,40,45,320);
		fd_ctx.strokeStyle = "white";
		fd_ctx.fillStyle = "white";
		fd_ctx.font = "small-caps normal 10px sans-serif";
		// scale
		for(sdown=-150; sdown<=140; sdown++){
			if((Math.floor(FD_altitude/10)+sdown)<0)continue;
			if(((Math.floor(FD_altitude/10)+sdown)%20)==0){
				fd_ctx.beginPath();
				fd_ctx.moveTo(361,center_y1+sdown);
				fd_ctx.lineTo(365,center_y1+sdown);
				fd_ctx.closePath();
				fd_ctx.stroke();
			}
			if(((FD_altitude-sdown)%100)==0) fd_ctx.fillText(FD_altitude-sdown, 367,center_y1+sdown+4);
		}
		fd_ctx.strokeStyle = "white";
		fd_ctx.fillStyle = "#000000";
		fd_ctx.fillRect(355,195,55,20);		
		fd_ctx.strokeRect(355,195,55,20);		
		fd_ctx.strokeStyle = "white";
		fd_ctx.fillStyle = "white";
		fd_ctx.font = "small-caps normal 14px sans-serif";
		if(FD_altitude > 0)fd_ctx.fillText(FD_altitude,362,210);

		// -- climb / descent rate
		fd_ctx.fillStyle = "#303032";
		fd_ctx.beginPath();
		fd_ctx.moveTo(410,120);
		fd_ctx.lineTo(440,120);
		fd_ctx.quadraticCurveTo(455,120,455,140);
		fd_ctx.lineTo(455,280);
		fd_ctx.quadraticCurveTo(455,290,440,290);
		fd_ctx.lineTo(410,290);
		fd_ctx.closePath();
		fd_ctx.fill();  
		//drawLine(fd_ctx,[210,455],[210,455+(FD_rate/100)],"white",3);   
		fd_ctx.strokeStyle = "white";
		fd_ctx.lineWidth = 2;
		fd_ctx.beginPath();
		fd_ctx.moveTo(455,210);
		fd_ctx.lineTo(415,210-((FD_rate/100)*1.1)); 
		fd_ctx.closePath();
		fd_ctx.stroke();
		fd_ctx.lineWidth = 1;
		fd_ctx.strokeStyle = "white";
		fd_ctx.font = "small-caps normal 9px sans-serif";
		if(FD_rate > 0)fd_ctx.strokeText("+" + FD_rate,412,340); else fd_ctx.strokeText(FD_rate,412,340);

		// -- heading
		fd_ctx.fillStyle = "#303032";
		fd_ctx.font = "small-caps normal 16px sans-serif";
		fd_ctx.beginPath();
		fd_ctx.moveTo(60,400);
		fd_ctx.quadraticCurveTo(200,335,340,400);
		fd_ctx.closePath();
		fd_ctx.fill();

		fd_ctx.strokeStyle = "white";
		fd_ctx.fillStyle = "white";
		if(FD_track >= 0 )fd_ctx.fillText(FD_track,190,390);

		// -- mach
		fd_ctx.strokeStyle = "green";
		fd_ctx.font = "small-caps normal 14px sans-serif";
		if(FD_mach > 0.5)fd_ctx.strokeText(FD_mach,5,395);

		// -- autopilot enabled
		fd_ctx.strokeStyle = "lightgreen";
		fd_ctx.fillStyle = "lightgreen";
		fd_ctx.font = "small-caps normal 18px sans-serif";
		if(FD_nav_heading!=-1 && FD_nav_altitude >0)fd_ctx.fillText("A/P",190,30);

		// -- autopilot altitude
		fd_ctx.strokeStyle = "magenta";
		fd_ctx.fillStyle = "magenta";
		fd_ctx.font = "small-caps normal 16px sans-serif";
		if(FD_nav_altitude > 0)fd_ctx.fillText(FD_nav_altitude,362,30);

		// -- autopilot QNH
		fd_ctx.strokeStyle = "cyan";
		fd_ctx.font = "small-caps normal 10px sans-serif";
		if(FD_nav_qnh > 0)fd_ctx.strokeText("QNH " + FD_nav_qnh,362,380);

		// -- autopilot heading 
		/*
		fd_ctx.strokeStyle = "cyan";
		fd_ctx.font = "small-caps normal 14px sans-serif";
		if(FD_nav_heading > 0)fd_ctx.strokeText(FD_nav_heading,190,368);
		*/
		/*
		drawLine(fd_ctx,[55,0],[55,50],'yellow',1);
		fd_ctx.fillRect(56,474,13,24);
		*/
		return;
	}

	function hideFD(){
		if(FD_locked_flight)return;
		clearInterval(FDtimer);
		document.getElementById("fd").style.display = "none";
		document.getElementById("fd-canvas").style.display = "none";
	}

	function clickOpenFD(flight){
		if(!document.getElementById("cb-FD-enabled").checked){		
			// in case FD is disabled, focus to flight clicked
			for(i=0; i<aircrafts_positions.length; i++){
				if(aircrafts_positions[i][0]==flight){ 
					// mymap.flyTo([aircrafts_positions[i][1],aircrafts_positions[i][2]],8);
					goToMapPoint(aircrafts_positions[i][1],aircrafts_positions[i][2],8);
					break;
				}
			}
		}
		// otherwise, lock the FD to the selected flight
		if(FD_locked_flight){ FD_flight = flight; FD_locked_flight = ""; hideFD(); return; }
		FD_locked_flight = flight;
		showFD();
	}

	function clickCloseFD(){
		FD_locked_flight = "";
		hideFD();
	}

	function onclickFD(e){
		var clickX, clickY;
		if(e.pageX || e.pageY){ clickX=e.pageX; clickY=e.pageY } else {
			clickX = e.clientX + document.body.scrollLeft + ddocument.documentElement.scrollLeft;
			clickY = e.clientY + document.body.scrollTop + ddocument.documentElement.scrollTop;
		}
		clickX -= fd_canvas.offsetLeft + 110; // had to calibrate manually..
		clickY -= fd_canvas.offsetTop + 105;
 		// close button click?
		if( clickX >= 438 && clickX <= 454 && clickY >= 0 && clickY <=20 )clickCloseFD();
		//console.log("Mouse click: " + clickX + "," + clickY);
	}

	/* handle ACs sort order change request */
	function onClickACHeader(col){
		var ah = document.getElementById("aircrafts-head");
		if(aircrafts_table_sort_col == col){
			if(aircrafts_table_sort_ascending)aircrafts_table_sort_ascending=false; else aircrafts_table_sort_ascending=true;}
		aircrafts_table_sort_col = col;
		aircrafts_table_sort_numeric = aircrafts_table_column_numerics[col];
		if(aircrafts_table_sort_ascending)
			ah.getElementsByTagName("TH")[col].style.background = "#600000";
		else
			ah.getElementsByTagName("TH")[col].style.background = "#006000";
	}

	/* Mark main receiver location */
	var circle = L.circle([receiver_lat, receiver_lon], {
    		color: 'blue',
    		fillColor: '#00f',
    		fillOpacity: 0.5,
    		radius: 2000
	}).addTo(mymap);

	/* Mark supplementary receiver location, if enabled */
	if( second_receiver_enabled ){
		var circle = L.circle([second_receiver_lat, second_receiver_lon], {
	    		color: 'red',
	    		fillColor: '#f00',
	    		fillOpacity: 0.2,
	    		radius: 2002
		}).addTo(mymap);
	}

    var getJSON = function(url, callback) {
    	var xhr = new XMLHttpRequest();
            xhr.open('GET', url, true);
            xhr.responseType='json';
            xhr.onload = function() {
            	var status=xhr.status;
                    if(status==200) callback(null, xhr.response);
                    	else callback(status, xhr.response);
            };
            xhr.send();
    }
	
	var layerGroup = L.layerGroup().addTo(mymap);

	const primary_icaos = []; // primary receiver icaos
	var aircrafts_positions = ["",0,0]; // all visible flights with callsign, lat, lon
	var second_ac_data = null; // supplementary / secondary receiver aircraft json - null if error
	var second_stat_data = null; // supplementary / secondary receiver statistics json - null if error

	var ac_count = 0, ac_with_pos_count = 0, ac_msgs = 0, ac_max_distance = 0, ac_max_distance_all_time = 0;

	// circular and altitude reception statistics
	// [receiver_label, angle (in int 0-359), min_distance, max_distance, max_distance_rssi, min_alt, max_alt]
	var receiver_circular_stats = [];
	for(i=0;i<360;i++)receiver_circular_stats.push([receiver_label,i,999,0,99,99999,0]);
	for(i=0;i<360;i++)receiver_circular_stats.push([second_receiver_label,i,999,0,99,99999,0]);

	// table sorting variables
	var aircrafts_table_sort_col = 8, aircrafts_table_sort_ascending = true, aircrafts_table_sort_numeric = true;
	const aircrafts_table_column_numerics = [false,false,true,false,true,true,true,true,true,true,true,true,false,false];

	function refreshAircrafts(){
		getJSON("http://" + receiver_domain + "/dump1090-fa/data/aircraft.json",
			function(err,data){
				if(err==null){
					document.getElementById("ecam-display").value.replace("  ADSB 1 FAIL",""); 
					// fetch secondary receiver data json, if enabled
					if( second_receiver_enabled ){
						getJSON("http://" + second_receiver_domain + "/dump1090-fa/data/aircraft.json",
							function(err,data){
								second_ac_data = null;
								if(err==null){ 
									second_ac_data = data;
				 					document.getElementById("ecam-display").value.replace("  ADSB 2 FAIL","");
								} else {
									document.getElementById("ecam-display").value += "  ADSB 2 FAIL";  
				 				}
							});
					}
					// begin update by clearing all the map data and redrawing the alti-bar box
					layerGroup.clearLayers();
					drawAltiBox();
					var ah = document.getElementById("aircrafts-head");
					var headHTML = "<th style='text-align: left;' onClick='onClickACHeader(0)'>Callsign</th><th onClick='onClickACHeader(1)'>Cat</th><th onClick='onClickACHeader(2)'>Track</th><th onClick='onClickACHeader(3)'>Squawk</th><th onClick='onClickACHeader(4)'>Alt</th><th onClick='onClickACHeader(5)'>Rate</th><th onClick='onClickACHeader(6)'>GS</th><th onClick='onClickACHeader(7)'>TAS</th><th onClick='onClickACHeader(8)'>Dist</th><th onClick='onClickACHeader(9)'>RSSI</th><th onClick='onClickACHeader(10)'>Seen</th><th onClick='onClickACHeader(11)'>Msgs</th><th onClick='onClickACHeader(12)'>Recvd</th><th onClick='onClickACHeader(13)'>L/D</th>";
					ah.innerHTML = headHTML;
					var al = document.getElementById("aircrafts-body");
					//al.innerHTML = "";
					var outHTML = "";

					// calculate zoom corrections for the aircraft map marker
					var zoom_correction_lat = 0.01, zoom_correction_lon = 0.02;
					var zoom_level = mymap.getZoom();
					if(zoom_level){
						zoom_correction_lat = 0.01 * (36/Math.pow(zoom_level,2));
						zoom_correction_lon = 0.02 * (36/Math.pow(zoom_level,2));
					}					

					ac_count = 0; ac_with_pos_count = 0; ac_msgs = 0; ac_max_distance = 0; 
					while( primary_icaos.length > 0 ) primary_icaos.pop(); // clear up primary icaos list
					while( aircrafts_positions.length > 0 ) aircrafts_positions.pop(); // clear up aircraft positions
					// parse through all the primary receiver aircrafts
					for(var key in data.aircraft)
					{
						var aci = data.aircraft[key];
						var lat=0, lon=0, altitude=-1, rate=0, track=-1, tas=-1, gs=-1, squawk="", seen=-1, rssi=0.0, msgs=0, cat="";
						var roll = 0, nav_altitude = 0, nav_heading = 0, nav_qnh = 0, mach = 0;
						var flight="", icao="";
						var position_received = ""; // which receiver had the position
						var company_name = "";

						ac_count++;	// update all aircrafts count

						if( aci.hex ) icao = aci.hex;
						primary_icaos.push(icao);

						var second_aci = null;
						// check secondary receiver data if this ac is in there
						if( second_ac_data )
							for( var k2 in second_ac_data.aircraft ){
								var tmp_aci = second_ac_data.aircraft[k2];
								if(tmp_aci) 
									if( tmp_aci.hex == icao ){
										second_aci = tmp_aci;
										break; 
									}
							}

						if(aci.flight)flight = aci.flight; else if(second_aci) if(second_aci.flight) flight = second_aci.flight;
						if(flight)company_name = findCompany(flight);
						if(!company_name) company_name = "";
						if(aci.squawk)squawk = aci.squawk; else if(second_aci) if(second_aci.squawk) squawk = second_aci.squawk;
						lat = aci.lat;
						lon = aci.lon;
						if(lat&&lon) position_received = receiver_label;
						if(!lat && second_aci) { if(second_aci.lat){ lat = second_aci.lat; position_received = second_receiver_label; } }
						if(!lon && second_aci) { if(second_aci.lon){ lon = second_aci.lon; position_received = second_receiver_label; } }
						if(position_received) ac_with_pos_count++;
						if(aci.alt_baro)altitude = aci.alt_baro; else if(second_aci) if(second_aci.alt_baro) altitude = second_aci.alt_baro;
						if(aci.baro_rate)rate = aci.baro_rate; else if(second_aci) if(second_aci.baro_rate) rate = second_aci.baro_rate;
						if(aci.track)track = Math.floor(aci.track); else if(second_aci) if(second_aci.track) track = Math.floor(second_aci.track);
						if(aci.tas)tas = aci.tas; else if(second_aci) if(second_aci.tas) tas = second_aci.tas;
						if(aci.gs)gs = aci.gs; else if(second_aci) if(second_aci.gs) gs = second_aci.gs;
						if(aci.rssi)rssi = aci.rssi;
						if(aci.seen)seen = aci.seen;
						if(aci.messages)msgs = aci.messages;
						ac_msgs+=msgs;
						if(aci.category)cat = aci.category;

						if(aci.roll)roll = aci.roll;
						if(aci.nav_altitude_mcp)nav_altitude = aci.nav_altitude_mcp;
						if(aci.nav_heading)nav_heading = aci.nav_heading;
						if(aci.nav_qnh)nav_qnh = aci.nav_qnh;
						if(aci.mach)mach = aci.mach;

						if(track<0)track="";
						if(altitude<0)altitude="";
						if(tas<0)tas="";
						if(gs<0)gs="";
						if(seen<0)seen="";
						if(seen>=100)seen = Math.floor(seen); 

						// Add flight to aircrafts_positions
						if(lat && lon)
							aircrafts_positions.push([flight,lat,lon]);

						// FD update
						if(flight == FD_flight){
		 					FD_tas = -1; FD_gs = -1; FD_altitude = -1; FD_rate = 0; FD_track = 0; FD_roll = 0; FD_mach = -1; FD_nav_altitude = -1; FD_nav_heading = -1;
							FD_effective_flight = FD_flight;
							FD_tas = tas;
							FD_gs = gs;
							FD_altitude = altitude;
							FD_rate = rate;
							FD_roll = roll;
							FD_mach = mach;
							FD_track = track;
							FD_nav_altitude = nav_altitude;
							FD_nav_heading = nav_heading;
							FD_nav_qnh = nav_qnh;
						}

						var distance = -1;
						if( lat && lon ) 
							if( position_received == receiver_label) {
								distance = getDistanceFromLatLonInKm(receiver_lat,receiver_lon,lat,lon,'km');
							} else {
								distance = getDistanceFromLatLonInKm(second_receiver_lat,second_receiver_lon,lat,lon,'km');								
							}
						if( distance > ac_max_distance ) ac_max_distance = Math.floor(distance);
						if( ac_max_distance > ac_max_distance_all_time) ac_max_distance_all_time = ac_max_distance;

						if( filters_map_checked ){
							if( lat && lon ){
								var map_center = mymap.getCenter();
								var ac_distance_to_center = getDistanceFromLatLonInKm(map_center.lat,map_center.lng,lat,lon,'km');
								// console.log("AC distance to center [" + map_center.lat + "," + map_center.lng +"]: " + ac_distance_to_center);
								if( ac_distance_to_center > filters_map_distance ) continue;
							} else continue;
						}

						//console.log(flight + " " + lat + "," + lon + " " + altitude);
						outHTML += "<tr>";
						var flight_style = " text-align: left;";
						var pos_style = "background: #101050;";
						if( position_received == second_receiver_label ) pos_style = "background: #101090;"; 
						if( !lat && !lon ) pos_style = "color: #8080A2;";
						var seen_style = "";
						if( seen > 15.0 ) seen_style = " color: #F07072";  
						if( seen > (1*60) ) pos_style += " text-decoration: line-through; text-decoration-color: #F00000;";
						var rssi_style = "";
						if( rssi >= -3.0 ) rssi_style = " color: #FFFFFF; background: #901010; ";
						var distance_style = "";
						if( distance < 50 ) distance_style = " color: #F07072";
						if( distance < 0 ) { distance = " "; distance_style = " color: #000000:"; }
						var squawk_style = "";
						if( squawk == "7700" || squawk == "7600" || squawk == "7500" ) squawk_style = " background: #FF0000; color: #FFFFFF; font-weight: bold;";

						var cat_explanation = "";
						switch(cat){
							case "A1" : { cat_explanation = "Class A1: Light"; break; }
							case "A2" : { cat_explanation = "Class A2: Small"; break; }
							case "A3" : { cat_explanation = "Class A3: Large"; break; }
							case "A4" : { cat_explanation = "Class A4: High vortext"; break; }
							case "A5" : { cat_explanation = "Class A5: Heavy"; break; }
							case "A6" : { cat_explanation = "Class A6: High Performance"; break; }
							case "A7" : { cat_explanation = "Class A7: Helicopter"; break; } 
							default: { break; }
						}

						var more_info = "Roll: " + roll + "\nSet heading: " + nav_heading + "\nSet altitude: " + nav_altitude + "\nSet QNH: " + nav_qnh;

						var avail = receiver_label;
						if(position_received==receiver_label) avail = "<span style='color: #80FF81; font-weight: bold;'>" + receiver_label + "</span>";
						if(second_aci && position_received!=second_receiver_label) avail += "+" + second_receiver_label;
						else if(second_aci && position_received==second_receiver_label) avail += "+<span style='color: #50FF51; font-weight: bold;'>" + second_receiver_label + "</span>";

						var flight_title = "ICAO hex: " + icao;
						if(selected_company_name) flight_title += "\nCompany: " + selected_company_name;
						if(selected_company_phrase) flight_title += "\nATC callsign: " + selected_company_phrase + " " + flight.substring(3);

						var near_airport = "", landing_departing = "";
						var ld_style = "text-align: center;";
						var ld_title = "";
						if( altitude < 10000 ){ // determine landing and departing aircrafts
							if( cat != "" && cat != "A1" && cat != "A7" ) // forget about light aircrafts and helicopters (too vague conditions for those)
								if( rate > 500 ){ // over +500 ft/min, could be departing if near runway
									for(i=0; i<nearest_longer_runways.length; i++){
										// within 30 miles (although not nautical miles)
										if(getDistanceFromLatLonInKm(nearest_longer_runways[i][4],nearest_longer_runways[i][5],lat,lon,'m')<30){
											near_airport = nearest_longer_runways[i][0];
											landing_departing = "D";
											ld_style += " background: #FFFFFF; color: #006F00;";
											ld_title = "Most likely departing from " + near_airport;
											break;
										}
									}
								} else if( rate < -250 ){ // steeper than -250 ft/min, could be landing if near runway
									for(i=0; i<nearest_longer_runways.length; i++){
										// within 30 miles (although not nautical miles)
										if(getDistanceFromLatLonInKm(nearest_longer_runways[i][4],nearest_longer_runways[i][5],lat,lon,'m')<30){
											near_airport = nearest_longer_runways[i][0];
											landing_departing = "L";
											ld_style += " background: #FFFFFF; color: #FF0000;";
											ld_title = "Most likely landing to " + near_airport;
											break;
										}
									}
								}
						}

						// update circular and altitude statistics
						if( lat && lon ){
							if(position_received==receiver_label){ 
								var angle = Math.floor(getAngleBetweenTwoLatLon(receiver_lat,receiver_lon,lat,lon));
								// [receiver_label, angle (in int 0-359), min_distance, max_distance, max_distance_rssi, min_alt, max_alt]
								for(i=0;i<360;i++){
									if(receiver_circular_stats[i][0] == receiver_label && receiver_circular_stats[i][1] == angle){
										if(distance < receiver_circular_stats[i][2])receiver_circular_stats[i][2]=distance;
										if(distance > receiver_circular_stats[i][3]){ receiver_circular_stats[i][3]=distance; receiver_circular_stats[i][4]=rssi; }
										if(altitude < receiver_circular_stats[i][5])receiver_circular_stats[i][5]=altitude;
										if(altitude > receiver_circular_stats[i][6])receiver_circular_stats[i][6]=altitude;
										break;
									} 
								}
							}
							if(position_received==second_receiver_label){
								var angle = getAngleBetweenTwoLatLon(second_receiver_lat,second_receiver_lon,lat,lon);
								for(i=360;i<receiver_circular_stats.length;i++){
									if(receiver_circular_stats[i][0] == second_receiver_label && receiver_circular_stats[i][1] == angle){
										if(distance < receiver_circular_stats[i][2])receiver_circular_stats[i][2]=distance;
										if(distance > receiver_circular_stats[i][3]){ receiver_circular_stats[i][3]=distance; receiver_circular_stats[i][4]=rssi; }
										if(altitude < receiver_circular_stats[i][5])receiver_circular_stats[i][5]=altitude;
										if(altitude > receiver_circular_stats[i][6])receiver_circular_stats[i][6]=altitude;
										break;
									} 
								}
							}
						}

						outHTML += "<td style='"+ pos_style + flight_style +"' onmouseover='showFD(\"" + flight + "\")' onmouseout='hideFD()'  onclick='clickOpenFD(\"" + flight + "\")' title='" + flight_title + "'>" + flight + "</td><td style='"+ pos_style +"' title='" + cat_explanation +"'>" + cat + "</td><td style='"+ pos_style +"' title='" + more_info + "'>" + track + "</td><td style='"+ pos_style + squawk_style +"' title='" + flight_title + "'>" + squawk + "</td><td style='"+ pos_style +"'>" + altitude + "</td><td style='"+ pos_style +"'>" + rate + "</td><td style='"+ pos_style +"'>" + Math.floor(gs) + "</td><td style='"+ pos_style +"'>" + Math.floor(tas) + "</td><td style='" + pos_style + distance_style + "'>" + Math.floor(distance) + "</td><td style='"+ pos_style + rssi_style + "'>" + rssi + "</td><td style='"+ pos_style + seen_style + "'>" + seen + "</td><td style='"+ pos_style + "'>" + msgs + "</td><td style='"+ pos_style + "'>" + avail + "</td><td style='"+ pos_style + ld_style + "' title='"+ ld_title +"'><a href='#" + near_airport + "'>" + landing_departing + "</a></td>"; 

						outHTML += "</tr>";
						//console.log( "|" + al.innerHTML + "|" );

						// refresh altimeter graph
						if( altitude > 0 ){
							if(canvas.getContext){
								const ctx = canvas.getContext("2d");
								if(flight)
									drawLine(ctx,[56,500-(altitude/100)],[69,500-(altitude/100)],'red',1);
								else
									drawLine(ctx,[56,500-(altitude/100)],[69,500-(altitude/100)],'darkyellow',1);
								var rate_prefix = " ";
								if(rate>70) {
									rate_prefix = "↑";
									ctx.strokeStyle = "green";
								} else if (rate<-70) {
									rate_prefix = "↓";
									ctx.strokeStyle = "red";
								} else { 
									ctx.strokeStyle = "blue";
								}
								ctx.font = "small-caps normal 9px sans-serif";
								if( seen < 20 ){
									ctx.strokeText(rate_prefix + " " + flight,74,500-(altitude/100)+4);
									ctx.strokeText((Math.floor(altitude/100)),31,500-(altitude/100)+4);
								}	
							}
						}

						// update map
						if( lat!=null && lon!=null ) 
						{
							// add position marker
							if(cat.substring(0,1)=="A" || cat.substring(0,1) == "")
								var ac = L.rectangle([[lat-zoom_correction_lat, lon-zoom_correction_lon], [lat+zoom_correction_lat,lon+zoom_correction_lon]], {
									color: '#00FF00',
									fillColor: '#000',
									fillOpacity: 0.9,
									radius: 2300
								}).addTo(layerGroup);
							else
								var ac = L.rectangle([[lat-0.00001, lon-0.00002], [lat+0.0001,lon+0.00002]], {
									color: '#FF00FF',
									fillColor: '#000',
									fillOpacity: 0.9,
									radius: 100
								}).addTo(layerGroup);
							// add heading line, variable by ground speed - indicating the ac position in the next 1 min if speed and heading are preserved
							var speed_km = gs *1.852;
							var headline_len = speed_km / 60;                           
							nextpoint_lat = 0; nextpoint_lon = 0;
							if( track ) calcNextPoint(lat,lon,track,headline_len); // indicator with km distance calculated from gs
							if( nextpoint_lat != 0 && nextpoint_lon != 0 ) {
							var headline = L.polyline([ [lat,lon],[nextpoint_lat,nextpoint_lon] ], { color: 'yellow', weight: 2, opacity: 0.5, smoothfactor: 1 }).addTo(layerGroup);
							}
							// add tooltip text
							var st_track = "-";
							if( track )st_track = Math.floor(track);
							var	st_alt = "FL" + Math.floor(altitude/100),
								st_rate = "-",
								st_squawk = "[<span style='color: #9092e0;'>" + squawk + "</span>]";
							if( !aci.squawk )st_squawk = ""; 
							if( (squawk == "7700") || (squawk == "7600") || (squawk == "7500") )
								st_squawk = "<span style='color: #ff0000; font-size: 1.2em;'><b> EM </b> [" + squawk + "]</span>";
							if( altitude < 5000 ) st_alt = altitude;
							if( rate > 0 ) st_rate = "&uarr;<span style='color:#40c041;'>" + rate + "</span>";
							if( rate < 0 ) st_rate = "&darr;<span style='color:#c04041;'>" + (-rate) + "</span>";
							if( !flight && !squawk )
								ac.bindTooltip(" " + st_track + "&deg; " + Math.floor(gs) + " " + st_alt + " " + st_rate, { permanent: true, direction: 'center', offset: [35,19] });
							else
								ac.bindTooltip("<span style='color: #70f072;'><b>" + flight + "</b></span> " + st_squawk + "<br/>" + st_track + "&deg; " + Math.floor(gs) + " " + st_alt + " " + st_rate, { permanent: true, direction: 'center', offset: [35,19] });
						}
					}
					al.innerHTML = outHTML; // populate aircraft table
					sortTable("aircrafts",aircrafts_table_sort_col,aircrafts_table_sort_ascending,aircrafts_table_sort_numeric); // sort by column 8 = distance, ascending, numeric information
					//debugTable();
					// insert footer with total counts to stats
					var footHTML = "";
					footHTML = "<tr>";
					footHTML += "<td style='text-align: right; font-size: 0.9em; font-weight: bold;'>" + ac_count + "</td>";
					footHTML += "<td colspan='2'>aircrafts in total</td>";					
					footHTML += "<td style='text-align: right; font-size: 0.9em; font-weight: bold;'>" + ac_with_pos_count + "</td>";
					footHTML += "<td colspan='2'>with positions</td>";
					footHTML += "<td style='text-align: right; font-size: 0.9em; font-weight: bold;'>" + ac_max_distance + "</td>";
					footHTML += "<td colspan='2'>km max dist.now</td>";
					/*					
					footHTML += "<td style='text-align: right; font-size: 0.9em; font-weight: bold;'>" + ac_msgs + "</td>";					
					footHTML += "<td colspan='2'>msgs</td>";					
					*/
					footHTML += "<td style='text-align: right; font-size: 0.9em; font-weight: bold;'>" + ac_max_distance_all_time + "</td>";
					footHTML += "<td colspan='2'>km this session</td>";					
					footHTML += "</tr>";
					document.getElementById("stats-footer").innerHTML = footHTML;					
				} else {
					document.getElementById("ecam-display").value += "  ADSB 1 FAIL"; 
				}
			}
		);
	}
	
	refreshAircrafts();
	var refreshACInterval = setInterval(refreshAircrafts, aircraft_refresh_rate);

	var receiver_noice = 0, receiver_signal = 0;

	function refreshStats(){
		getJSON("http://" + receiver_domain + "/dump1090-fa/data/stats.json",
			function(err,data){
				if(err==null){
					var sh = document.getElementById("stats-head");
					var label_style = "background: #80F081; text-align: center;";
					var hrate_style = "background: #F0F081; text-align: center;";
					var h5_style = "background: #80F081; text-align: center;";
					var h15_style = " text-align: center;";
					sh.innerHTML="<th style='"+label_style+"; width: 30px;'><br/>#</th><th style='"+hrate_style+"'>Msg<br/>Rate</th><th style='"+h5_style+"'>5 min<br/>Peak</th><th style='"+h5_style+"'><br/>Sig</th><th style='"+h5_style+"'><br/>Noise</th><th style='"+h5_style+"'><br/>Msgs</th><th style='"+h5_style+"'><br/>Pos</th><th style='"+h15_style+"'>15 min<br/>Peak</th><th style='"+h15_style+"'><br/>Sig</th><th style='"+h15_style+"'><br/>Noise</th><th style='"+h15_style+"'><br/>Msgs</th><th style='"+h15_style+"'><br/>Pos</th>";
					var st = document.getElementById("stats-body");
					var outHTML = "";
					//for(var key in data)
					{
						var msgs = 0.0, msgrate = 0.0; 
						var noise5 = 0.0, peak5 = 0.0, sig5 = 0.0, msgs5 = 0, pos5 = 0, ok5 = 0;
						var noise15 = 0.0, peak15 = 0.0, sig15 = 0.0, msgs15 = 0, pos15 = 0, ok15 = 0;

						if(data.last1min.messages) msgs = data.last1min.messages;
						if(data.last1min.local.noise) receiver_noise = data.last1min.local.noise;
						if(data.last1min.local.signal) receiver_signal = data.last1min.local.signal;
						msgrate = (msgs / 60).toFixed(1);

						if(data.last5min.local.noise) noise5 = data.last5min.local.noise;
						if(data.last5min.local.signal) sig5 = data.last5min.local.signal;
						if(data.last5min.local.peak_signal) peak5 = data.last5min.local.peak_signal;
						if(data.last5min.cpr.local_ok) ok5 = data.last5min.cpr.local_ok;									
						if(data.last5min.cpr.airborne) pos5 = data.last5min.cpr.airborne;
						if(data.last5min.messages) msgs5 = data.last5min.messages;

						if(data.last15min.local.noise) noise15 = data.last15min.local.noise;
						if(data.last15min.local.signal) sig15 = data.last15min.local.signal;
						if(data.last15min.local.peak_signal) peak15 = data.last15min.local.peak_signal;
						if(data.last15min.cpr.local_ok) ok15 = data.last15min.cpr.local_ok;
						if(data.last15min.cpr.airborne) pos15 = data.last15min.cpr.airborne;
						if(data.last15min.messages) msgs15 = data.last15min.messages;

						var stat_style = " text-align: center;";

						var rate_style = " color: #B0B0FF;";
						if(msgrate < 2) rate_style = " color: #FF1011;";
						if(msgrate > 50) rate_style = " color: #80FF81;";

						var sig5_style = "";
						if(sig5 > -3.0) sig5_style = " color: #FF1011;";

						var sig15_style = "";
						if(sig15 > -3.0) sig15_style = " color: #FF1011;";

						outHTML += "<tr>";

						outHTML += "<td style='" + stat_style + "'>" + receiver_label + "</td>" + "<td style='" + stat_style + rate_style + "'>" + msgrate + "</td>" + "<td style='" + stat_style + "'>" + peak5 + "</td>" + "<td style='" + stat_style + sig5_style + "'>" + sig5 + "</td>" + "<td style='" + stat_style + "'>" + noise5 + "</td>" + "<td style='" + stat_style + "'>" + msgs5 + "</td>" + "<td style='" + stat_style + "'>" + pos5 + "</td>" + "<td style='" + stat_style + "'>" + peak15 + "</td>" + "<td style='" + stat_style + sig15_style + "'>" + sig15 + "</td>" + "<td style='" + stat_style + "'>" + noise15 + "</td>" + "<td style='" + stat_style + "'>" + msgs15 + "</td>" + "<td style='" + stat_style + "'>" + pos15 + "</td>";

						outHTML += "</tr>";
					}
					// fetch secondary receiver data json, if enabled
					if( second_receiver_enabled ){
						getJSON("http://" + second_receiver_domain + "/dump1090-fa/data/stats.json",
								function(err,data){
									second_stat_data = null;
									if(err==null) second_stat_data = data;
								});
					}
					if( second_stat_data )
					{
						msgs = 0.0; msgrate = 0.0; 
						noise5 = 0.0; peak5 = 0.0; sig5 = 0.0; msgs5 = 0; pos5 = 0; ok5 = 0;
						noise15 = 0.0; peak15 = 0.0; sig15 = 0.0; msgs15 = 0; pos15 = 0; ok15 = 0;

						if(second_stat_data.last1min.messages) msgs = second_stat_data.last1min.messages;
						msgrate = (msgs / 60).toFixed(1);

						if(second_stat_data.last5min.local.noise) noise5 = second_stat_data.last5min.local.noise;
						if(second_stat_data.last5min.local.signal) sig5 = second_stat_data.last5min.local.signal;
						if(second_stat_data.last5min.local.peak_signal) peak5 = second_stat_data.last5min.local.peak_signal;
						if(second_stat_data.last5min.cpr.local_ok) ok5 = second_stat_data.last5min.cpr.local_ok;									
						if(second_stat_data.last5min.cpr.airborne) pos5 = second_stat_data.last5min.cpr.airborne;
						if(second_stat_data.last5min.messages) msgs5 = second_stat_data.last5min.messages;

						if(second_stat_data.last15min.local.noise) noise15 = second_stat_data.last15min.local.noise;
						if(second_stat_data.last15min.local.signal) sig15 = second_stat_data.last15min.local.signal;
						if(second_stat_data.last15min.local.peak_signal) peak15 = second_stat_data.last15min.local.peak_signal;
						if(second_stat_data.last15min.cpr.local_ok) ok15 = second_stat_data.last15min.cpr.local_ok;
						if(second_stat_data.last15min.cpr.airborne) pos15 = second_stat_data.last15min.cpr.airborne;
						if(second_stat_data.last15min.messages) msgs15 = second_stat_data.last15min.messages;

						stat_style = " text-align: center; background: #202021;";

						rate_style = " color: #B0B0FF;";
						if(msgrate < 10) rate_style = " color: #FF1011;";
						if(msgrate > 50) rate_style = " color: #80FF81;";

						var sig5_style = "";
						if(sig5 > -3.0) sig5_style = " color: #FF1011;";

						var sig15_style = "";
						if(sig15 > -3.0) sig15_style = " color: #FF1011;";

						outHTML += "<tr>";

						outHTML += "<td style='" + stat_style + "'>" + second_receiver_label + "</td>" + "<td style='" + stat_style + rate_style + "'>" + msgrate + "</td>" + "<td style='" + stat_style + "'>" + peak5 + "</td>" + "<td style='" + stat_style + sig5_style + "'>" + sig5 + "</td>" + "<td style='" + stat_style + "'>" + noise5 + "</td>" + "<td style='" + stat_style + "'>" + msgs5 + "</td>" + "<td style='" + stat_style + "'>" + pos5 + "</td>" + "<td style='" + stat_style + "'>" + peak15 + "</td>" + "<td style='" + stat_style + sig15_style + "'>" + sig15 + "</td>" + "<td style='" + stat_style + "'>" + noise15 + "</td>" + "<td style='" + stat_style + "'>" + msgs15 + "</td>" + "<td style='" + stat_style + "'>" + pos15 + "</td>";

						outHTML += "</tr>";
					}
					st.innerHTML = outHTML;
				}
			}
		);
    }

	refreshStats();
	var refreshStatsInterval = setInterval(refreshStats, stats_refresh_rate);

	var layerGroupRunways = new L.layerGroup().addTo(mymap);

	function addRunwayToMap(airport,num1,lat1,lon1,num2,lat2,lon2,len){
		var point1 = new L.LatLng(lat1,lon1);
		var point2 = new L.LatLng(lat2,lon2);
		var pointlist = [point1,point2];
		if(len<8000) // smaller runways
			var runway_line = new L.polyline(pointlist, {
				color: '#1010C1',
				weight: 4,
				opacity: 0.4,
				smoothFactor: 1
			});
		else // major runways
			var runway_line = new L.polyline(pointlist, {
				color: '#F030F1',
				weight: 4,
				opacity: 0.4,
				smoothFactor: 1
			});
		runway_line.addTo(layerGroupRunways);
		runway_line.bindTooltip(airport + " " + num1 + " / " + num2, { permanent: false, direction: 'center', offset: [0,0], opacity: 1 });
	}

	function parseRunwayData(text, delimeter = ","){
		text = text.replace(/["']/g,""); // remove double quotes
		const headers = text.slice(0,text.indexOf("\n")).split(delimeter);
		const rows = text.slice(text.indexOf("\n")+1).split("\n");
		const runways = rows.map(function (row) {
			const values = row.split(delimeter);
			const runway = headers.reduce(function (object, header, index){
				if(values[index]) object[header] = values[index]; else object[header] = "";
				return object;
			}, {});
			return runway;
		});
		return runways;
	}
	var raw_runway_data = "";
	var nearest_runways = [["","","","","","","","","","",""]]; // airport code (airport_ident), runway start number (le_ident), runway end number (he_ident), elevation (le_elevation_ft), start lat (le_latitude_deg), start lon (le_longitude_deg), end lat (he_latitude_deg), end lon (he_longitude_deg), surface, length (length_ft), width (width_ft)
	var nearest_longer_runways = [["","","","","","","","","","",""]];
	function refreshAirportdata(){
		if(!airports_enabled){
			document.getElementById("airports-cb").innerHTML += " <label class='form-control'><input type='checkbox' id='airports-enabled' onclick='airportsEnabledChange()' class='runways-cb' disabled> Runways</label>";		
			document.getElementById("ecam-display").value += "  RUNWAYS INOP"; 
			return;
		}
		// load csv of runway data (credits to ourairports.com) - fetch only once
		if(!raw_runway_data) {
			console.log("Loading runways");
			fetch("runways.csv")
				.then(response => { if(response.ok)return response.text();else throw new Error("Fetching runways failed"); })
				.then(data => {
					raw_runway_data = parseRunwayData(data,",");
					console.log("Runways loaded");
					findNearestRunways();
					var rwh = document.getElementById("runways-head");
					var outHTML = "";
					// TO DO: get weather information for those airports
					rwh.innerHTML = "<th style='width: 45px;'>Airport</th><th style='width: 60px;'>Runway</th><th>Elev.</th><th style='width: 50px;'>Length</th><th>Width</th><th style='width: 80px;'>Surface</th><th style='background:#40C0FF;'>A72</th><th>E17</th><th style='background:#40C0FF;'>737</th><th>747</th><th style='background:#40C0FF;'>767</th><th>777</th><th style='background:#40C0FF;'>787</th><th>319</th><th style='background:#40C0FF;'>320</th><th>321</th><th style='background:#40C0FF;'>330</th><th>350</th><th style='background:#40C0FF;'>380</th><th style='width: 100px;'>Aircrafts</th>";
					refreshAirportAircraftdata();
				})
				.catch((error) => {
					document.getElementById("ecam-display").value += "  RUNWAYS FAIL"; 
					console.error;
				});
		} 
		document.getElementById("airports-cb").innerHTML += " <label class='form-control'><input type='checkbox' id='airports-enabled' onclick='airportsEnabledChange()' class='runways-cb' checked> Runways</label>";		
	}
	function airportsEnabledChange(){
		if(document.getElementById("airports-enabled").checked){
			findNearestRunways();
		} else {
			layerGroupRunways.clearLayers();
		}
	}

	// process data into array of nearest runways
	function findNearestRunways(){
		for(c=0; c<nearest_runways.length; c++)nearest_runways.pop(); // empty the nearest runways array first before repopulating it
		{
			var min_lat, max_lat, min_lon, max_lon;
			var map_bounds = mymap.getBounds();
			min_lon = map_bounds.getWest(); max_lon = map_bounds.getEast();
			min_lat = map_bounds.getSouth(); max_lat = map_bounds.getNorth();
			console.log("Detecting nearest runways from " + raw_runway_data.length + " runways (" + min_lat + "-" + max_lat + "," + min_lon + "-" + max_lon);
			//console.log(raw_runway_data);
			for(i=0; i<raw_runway_data.length; i++){
				// ditch all the 0 lat and/or lon value runways (error data)
				if(raw_runway_data[i].le_latitude_deg==0 || raw_runway_data[i].le_longitude_deg == 0 || raw_runway_data[i].he_latitude_deg==0 || raw_runway_data[i].he_longitude_deg==0) continue;
				// fetch using only start of the runways (might cut some of the runways at the sides of the map)
				if(raw_runway_data[i].le_latitude_deg >= min_lat && raw_runway_data[i].le_latitude_deg <= max_lat && raw_runway_data[i].le_longitude_deg >= min_lon && raw_runway_data[i].le_longitude_deg <= max_lon){
					var airport_code = "", r_start_number = "", r_end_number = "", r_elevation = "";
					var r_start_lat = "", r_start_lon = "", r_end_lat = "", r_end_lon = "";
					var r_surface = "", r_length = "";
					airport_code = raw_runway_data[i].airport_ident;
					r_start_number = raw_runway_data[i].le_ident;
					r_end_number = raw_runway_data[i].he_ident;
					r_elevation = raw_runway_data[i].le_elevation_ft;
					r_start_lat = raw_runway_data[i].le_latitude_deg; 
					r_start_lon = raw_runway_data[i].le_longitude_deg; 
					r_end_lat = raw_runway_data[i].he_latitude_deg; 
					r_end_lon = raw_runway_data[i].he_longitude_deg;
					r_surface = raw_runway_data[i].surface;
					r_length = raw_runway_data[i].length_ft;
					r_width = raw_runway_data[i].width_ft;
					nearest_runways.push([airport_code, r_start_number, r_end_number, r_elevation, r_start_lat, r_start_lon, r_end_lat, r_end_lon,r_surface,r_length,r_width]);
					if(r_length>8000)
						nearest_longer_runways.push([airport_code, r_start_number, r_end_number, r_elevation, r_start_lat, r_start_lon, r_end_lat, r_end_lon,r_surface,r_length,r_width]);
					addRunwayToMap(airport_code,r_start_number,r_start_lat,r_start_lon,r_end_number,r_end_lat,r_end_lon,r_length); 
					//console.log(raw_runway_data[i]);
				}				
			}
			console.log("Nearest runways determined");
		}
		console.log(nearest_runways);
	}
	refreshAirportdata();

	function refreshAirportAircraftdata(){
		var rwd = document.getElementById("runways-body");
		var num_of_runways = 0;
		var outHTML = "";
		for( i=0; i<nearest_runways.length; i++ ){
			var style_common = " cursor: pointer;";
			var a_no = "background: #400000;", a_maybe = "background: #404000", a_yes = "background: #004000";
			if(nearest_runways[i][9]<5000) style_common += " background: #000000; color: #707071;"; // smaller runways
			if(nearest_runways[i][9]>=7000 && nearest_runways[i][9]<8000) style_common += " background: #000141";
			if(nearest_runways[i][9]>=8000 && nearest_runways[i][9]<9000) style_common += " background: #102151";
			if(nearest_runways[i][9]>=9000 && nearest_runways[i][9]<10000) style_common += " background: #302171";
			if(nearest_runways[i][9]>=10000) style_common += " background: #502191";
			outHTML += "<tr onClick='goToMapPoint(" + nearest_runways[i][4] + "," + nearest_runways[i][5] + ",8)'>";
			outHTML += "<td style='"+ style_common + "'><a name='" + nearest_runways[i][0] + "'>" + nearest_runways[i][0] + "</a></td>";
			outHTML += "<td style='"+ style_common + "'>" + nearest_runways[i][1] + " / " + nearest_runways[i][2] + "</td>";
			outHTML += "<td style='"+ style_common + "'>" + nearest_runways[i][3] + "</td>"; // elevation
			outHTML += "<td style='"+ style_common + "'>" + nearest_runways[i][9] + "</td>"; // length
			outHTML += "<td style='"+ style_common + "'>" + nearest_runways[i][10] + "</td>"; // width
			outHTML += "<td style='"+ style_common + "'>" + nearest_runways[i][8] + "</td>"; // surface
			// <th>AT72</th><th>E170</th><th>737</th><th>747</th><th>757</th><th>767</th><th>777</th><th>787</th><th>319</th><th>320</th><th>321</th><th>330</th><th>340</th><th>350</th><th>380</th>
			// Take-off capabilities of some commercial aircrafts with MTOW
			if(nearest_runways[i][9]<4500)
			{
				outHTML += "<td style='"+ a_no +"'>-</td>"; // ATR 72
				outHTML += "<td style='"+ a_no +"'>-</td>"; // E170
				outHTML += "<td style='"+ a_no +"'>-</td>"; // B737
				outHTML += "<td style='"+ a_no +"'>-</td>"; // B747
				outHTML += "<td style='"+ a_no +"'>-</td>"; // B767
				outHTML += "<td style='"+ a_no +"'>-</td>"; // B777
				outHTML += "<td style='"+ a_no +"'>-</td>"; // B787
				outHTML += "<td style='"+ a_no +"'>-</td>"; // A319
				outHTML += "<td style='"+ a_no +"'>-</td>"; // A320
				outHTML += "<td style='"+ a_no +"'>-</td>"; // A321
				outHTML += "<td style='"+ a_no +"'>-</td>"; // A330
				outHTML += "<td style='"+ a_no +"'>-</td>"; // A350
				outHTML += "<td style='"+ a_no +"'>-</td>"; // A380
			}
			if(nearest_runways[i][9]>=4500 && nearest_runways[i][9]<5500)
			{
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // ATR 72
				outHTML += "<td style='"+ a_no +"'>-</td>"; // E170
				outHTML += "<td style='"+ a_no +"'>-</td>"; // B737
				outHTML += "<td style='"+ a_no +"'>-</td>"; // B747
				outHTML += "<td style='"+ a_no +"'>-</td>"; // B767
				outHTML += "<td style='"+ a_no +"'>-</td>"; // B777
				outHTML += "<td style='"+ a_no +"'>-</td>"; // B787
				outHTML += "<td style='"+ a_no +"'>-</td>"; // A319
				outHTML += "<td style='"+ a_no +"'>-</td>"; // A320
				outHTML += "<td style='"+ a_no +"'>-</td>"; // A321
				outHTML += "<td style='"+ a_no +"'>-</td>"; // A330
				outHTML += "<td style='"+ a_no +"'>-</td>"; // A350
				outHTML += "<td style='"+ a_no +"'>-</td>"; // A380
			}
			if(nearest_runways[i][9]>=5500 && nearest_runways[i][9]<6000)
			{
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // ATR 72
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // E170
				outHTML += "<td style='"+ a_maybe +"'>o</td>"; // B737
				outHTML += "<td style='"+ a_no +"'>-</td>"; // B747
				outHTML += "<td style='"+ a_no +"'>-</td>"; // B767
				outHTML += "<td style='"+ a_no +"'>-</td>"; // B777
				outHTML += "<td style='"+ a_no +"'>-</td>"; // B787
				outHTML += "<td style='"+ a_no +"'>-</td>"; // A319
				outHTML += "<td style='"+ a_no +"'>-</td>"; // A320
				outHTML += "<td style='"+ a_no +"'>-</td>"; // A321
				outHTML += "<td style='"+ a_no +"'>-</td>"; // A330
				outHTML += "<td style='"+ a_no +"'>-</td>"; // A350
				outHTML += "<td style='"+ a_no +"'>-</td>"; // A380
			}
			if(nearest_runways[i][9]>=6000 && nearest_runways[i][9]<6500)
			{
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // ATR 72
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // E170
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // B737
				outHTML += "<td style='"+ a_no +"'>-</td>"; // B747
				outHTML += "<td style='"+ a_no +"'>-</td>"; // B767
				outHTML += "<td style='"+ a_no +"'>-</td>"; // B777
				outHTML += "<td style='"+ a_no +"'>-</td>"; // B787
				outHTML += "<td style='"+ a_no +"'>-</td>"; // A319
				outHTML += "<td style='"+ a_no +"'>-</td>"; // A320
				outHTML += "<td style='"+ a_no +"'>-</td>"; // A321
				outHTML += "<td style='"+ a_no +"'>-</td>"; // A330
				outHTML += "<td style='"+ a_no +"'>-</td>"; // A350
				outHTML += "<td style='"+ a_no +"'>-</td>"; // A380
			}
			if(nearest_runways[i][9]>=6500 && nearest_runways[i][9]<7000)
			{
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // ATR 72
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // E170
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // B737
				outHTML += "<td style='"+ a_no +"'>-</td>"; // B747
				outHTML += "<td style='"+ a_no +"'>-</td>"; // B767
				outHTML += "<td style='"+ a_no +"'>-</td>"; // B777
				outHTML += "<td style='"+ a_no +"'>-</td>"; // B787
				outHTML += "<td style='"+ a_no +"'>-</td>"; // A319
				outHTML += "<td style='"+ a_maybe +"'>o</td>"; // A320
				outHTML += "<td style='"+ a_no +"'>-</td>"; // A321
				outHTML += "<td style='"+ a_no +"'>-</td>"; // A330
				outHTML += "<td style='"+ a_no +"'>-</td>"; // A350
				outHTML += "<td style='"+ a_no +"'>-</td>"; // A380
			}
			if(nearest_runways[i][9]>=7000 && nearest_runways[i][9]<7500)
			{
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // ATR 72
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // E170
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // B737
				outHTML += "<td style='"+ a_no +"'>-</td>"; // B747
				outHTML += "<td style='"+ a_no +"'>-</td>"; // B767
				outHTML += "<td style='"+ a_no +"'>-</td>"; // B777
				outHTML += "<td style='"+ a_no +"'>-</td>"; // B787
				outHTML += "<td style='"+ a_maybe +"'>o</td>"; // A319
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // A320
				outHTML += "<td style='"+ a_no +"'>-</td>"; // A321
				outHTML += "<td style='"+ a_no +"'>-</td>"; // A330
				outHTML += "<td style='"+ a_no +"'>-</td>"; // A350
				outHTML += "<td style='"+ a_no +"'>-</td>"; // A380
			}
			if(nearest_runways[i][9]>=7500 && nearest_runways[i][9]<8000)
			{
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // ATR 72
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // E170
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // B737
				outHTML += "<td style='"+ a_no +"'>-</td>"; // B747
				outHTML += "<td style='"+ a_no +"'>-</td>"; // B767
				outHTML += "<td style='"+ a_no +"'>-</td>"; // B777
				outHTML += "<td style='"+ a_no +"'>-</td>"; // B787
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // A319
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // A320
				outHTML += "<td style='"+ a_no +"'>-</td>"; // A321
				outHTML += "<td style='"+ a_maybe +"'>o</td>"; // A330
				outHTML += "<td style='"+ a_no +"'>-</td>"; // A350
				outHTML += "<td style='"+ a_no +"'>-</td>"; // A380
			}
			if(nearest_runways[i][9]>=8000 && nearest_runways[i][9]<8500)
			{
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // ATR 72
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // E170
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // B737
				outHTML += "<td style='"+ a_no +"'>-</td>"; // B747
				outHTML += "<td style='"+ a_no +"'>-</td>"; // B767
				outHTML += "<td style='"+ a_no +"'>-</td>"; // B777
				outHTML += "<td style='"+ a_maybe +"'>o</td>"; // B787
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // A319
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // A320
				outHTML += "<td style='"+ a_maybe +"'>o</td>"; // A321
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // A330
				outHTML += "<td style='"+ a_no +"'>-</td>"; // A350
				outHTML += "<td style='"+ a_no +"'>-</td>"; // A380
			}
			if(nearest_runways[i][9]>=8500 && nearest_runways[i][9]<9500)
			{
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // ATR 72
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // E170
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // B737
				outHTML += "<td style='"+ a_no +"'>-</td>"; // B747
				outHTML += "<td style='"+ a_no +"'>-</td>"; // B767
				outHTML += "<td style='"+ a_no +"'>-</td>"; // B777
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // B787
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // A319
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // A320
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // A321
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // A330
				outHTML += "<td style='"+ a_maybe +"'>o</td>"; // A350
				outHTML += "<td style='"+ a_no +"'>-</td>"; // A380
			}
			if(nearest_runways[i][9]>=9500 && nearest_runways[i][9]<10000)
			{
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // ATR 72
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // E170
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // B737
				outHTML += "<td style='"+ a_no +"'>-</td>"; // B747
				outHTML += "<td style='"+ a_maybe +"'>o</td>"; // B767
				outHTML += "<td style='"+ a_no +"'>-</td>"; // B777
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // B787
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // A319
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // A320
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // A321
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // A330
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // A350
				outHTML += "<td style='"+ a_maybe +"'>o</td>"; // A380
			}
			if(nearest_runways[i][9]>=10000 && nearest_runways[i][9]<10500)
			{
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // ATR 72
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // E170
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // B737
				outHTML += "<td style='"+ a_no +"'>-</td>"; // B747
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // B767
				outHTML += "<td style='"+ a_no +"'>-</td>"; // B777
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // B787
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // A319
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // A320
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // A321
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // A330
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // A350
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // A380
			}
			if(nearest_runways[i][9]>=10500 && nearest_runways[i][9]<11000)
			{
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // ATR 72
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // E170
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // B737
				outHTML += "<td style='"+ a_maybe +"'>o</td>"; // B747
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // B767
				outHTML += "<td style='"+ a_no +"'>-</td>"; // B777
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // B787
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // A319
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // A320
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // A321
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // A330
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // A350
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // A380
			}
			if(nearest_runways[i][9]>=11000 && nearest_runways[i][9]<11500)
			{
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // ATR 72
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // E170
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // B737
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // B747
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // B767
				outHTML += "<td style='"+ a_maybe +"'>o</td>"; // B777
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // B787
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // A319
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // A320
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // A321
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // A330
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // A350
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // A380
			}
			if(nearest_runways[i][9]>=11500)
			{
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // ATR 72
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // E170
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // B737
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // B747
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // B767
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // B777
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // B787
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // A319
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // A320
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // A321
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // A330
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // A350
				outHTML += "<td style='"+ a_yes +"'>x</td>"; // A380
			}
			outHTML += "<td style='"+ style_common + "'>"; // near-by aircrafts
			var acs = 0;
			for( a=0; a<aircrafts_positions.length; a++){
				if(!aircrafts_positions[a][0])continue; // do not try to show empty flight name string
				if(nearest_runways[i][9]>=5000) // do not display aircrafts if runway is less than 5000ft (clearing things)
					if( getDistanceFromLatLonInKm(nearest_runways[i][4],nearest_runways[i][5],aircrafts_positions[a][1],aircrafts_positions[a][2],'km') <= 88 ) { // 88 km is the zoom level 9
						if(acs>0) outHTML += ", ";
						outHTML += "<span onClick='goToMapPoint(" + aircrafts_positions[a][1] + "," + aircrafts_positions[a][2] + ",9)'>" + aircrafts_positions[a][0].trim() + "</span>"; 
						acs++;
					} 
			}
			outHTML += "</td>";
			outHTML += "</tr>";
			num_of_runways++;
		}
		rwd.innerHTML = outHTML;
		//console.log("Airport aircrafts updated (" + num_of_runways + " runways checked)");
	}
	var refreshAirportAircraftsInterval = setInterval(refreshAirportAircraftdata, airport_aircraft_refresh_rate);


	// ------ second page
	var rc_canvas = document.getElementById("receiver-circular-canvas");
	var rc_ctx = rc_canvas.getContext("2d");
	var receiver_snr_min = -99, receiver_snr_max = 0;
	const max_cs_distance = 450;
	function getAngleEndpoint(x,y,r,angle){  // in degrees
		angle = angle - 90;
		var rad_angle = (angle*Math.PI)/180;
		return [Math.floor(x+Math.cos(rad_angle)*r),Math.floor(y+Math.sin(rad_angle)*r)];
	}
	function initCircularStats(){
		rc_ctx.clearRect(0,0,fd_canvas.width,fd_canvas.height);
		rc_ctx.beginPath();
		rc_ctx.fillStyle = "#AFAFFF";
		rc_ctx.strokeStyle = "white";
		rc_ctx.arc(150,150,140,0,2*Math.PI);
		rc_ctx.closePath();
		rc_ctx.stroke();
		rc_ctx.fillStyle = "#FFFFFF";
		rc_ctx.beginPath();
		rc_ctx.arc(150,150,5,0,2*Math.PI);
		rc_ctx.closePath();
		rc_ctx.fill();
		rc_ctx.fillStyle = "#FFFFFF";
		rc_ctx.font = "normal 16px sans-serif"; // small-caps 
		rc_ctx.fillText(receiver_label,1,10);
		var receiver_snr = 0;
		if(receiver_noise<0) receiver_snr = receiver_noise - receiver_signal;
		if(receiver_snr < receiver_snr_max) receiver_snr_max = receiver_snr;
		if(receiver_snr > receiver_snr_min) receiver_snr_min = receiver_snr;
		rc_ctx.fillStyle = "#AFAFFF";
		rc_ctx.font = "normal 10px sans-serif"; // small-caps 
		rc_ctx.fillText("SNR " + receiver_snr.toFixed(1) + " dBi",1,280);		 
		rc_ctx.font = "normal 8px sans-serif"; // small-caps 
		rc_ctx.fillText("min " + receiver_snr_min.toFixed(1) + " dBi",1,290);		 
		rc_ctx.font = "normal 8px sans-serif"; // small-caps 
		rc_ctx.fillText("max " + receiver_snr_max.toFixed(1) + " dBi",1,300);		 
	}
	function refreshCircularStats() {
		initCircularStats();
		var next_x = -1, next_y = -1;
		// approximations
		rc_ctx.fillStyle = "#5F5F9F";
		rc_ctx.strokeStyle = "#9092FF";
		rc_ctx.beginPath();
		rc_ctx.moveTo(150, 150);
		for(i=0; i<360; i++){
			// [receiver_label, angle (in int 0-359), min_distance, max_distance, max_distance_rssi, min_alt, max_alt]
			if(receiver_circular_stats[i][0]==receiver_label){
				if(receiver_circular_stats[i][4]!=99){
					var dist = (receiver_circular_stats[i][3]/max_cs_distance)*(140);
					if(dist>140)dist=140;
					var next_pos = getAngleEndpoint(150,150,dist,receiver_circular_stats[i][1]);
					next_x = next_pos[0]; next_y = next_pos[1];
					rc_ctx.lineTo(next_x, next_y);
					// console.log(receiver_circular_stats[i][1] + " dist: " + dist + " - " + next_x + "," + next_y);
				}
			}
		}
		rc_ctx.lineTo(150, 150);
		rc_ctx.closePath();
		rc_ctx.fill();
		// strict
		rc_ctx.fillStyle = "#EF8FFF";
		rc_ctx.strokeStyle = "#9092FF";
		rc_ctx.beginPath();
		rc_ctx.moveTo(150, 150);
		for(i=0; i<360; i++){
			// [receiver_label, angle (in int 0-359), min_distance, max_distance, max_distance_rssi, min_alt, max_alt]
			if(receiver_circular_stats[i][0]==receiver_label){
				var dist = (receiver_circular_stats[i][3]/max_cs_distance)*(140);
				if(dist>140)dist=140;
				var next_pos = getAngleEndpoint(150,150,dist,receiver_circular_stats[i][1]);
				next_x = next_pos[0]; next_y = next_pos[1];
				rc_ctx.lineTo(next_x, next_y);
			}
		}
		rc_ctx.lineTo(150, 150);
		rc_ctx.closePath();
		rc_ctx.stroke();
		rc_ctx.fillStyle = "#FFFFFF";
		rc_ctx.strokeStyle = "white";
		rc_ctx.beginPath();
		rc_ctx.arc(150,150,5,0,2*Math.PI);
		rc_ctx.closePath();
		rc_ctx.fill();
		//console.log(receiver_circular_stats);

		// cross-hairs / measurement lines
		rc_ctx.strokeStyle = "#505052";
		rc_ctx.beginPath();
		rc_ctx.moveTo(10, 150);
		rc_ctx.lineTo(290, 150);
		rc_ctx.moveTo(150, 10);
		rc_ctx.lineTo(150, 290);
		rc_ctx.closePath();
		rc_ctx.stroke();
		rc_ctx.beginPath();
		rc_ctx.strokeStyle = "#505072";
		rc_ctx.arc(150,150,(100/max_cs_distance)*140,0,2*Math.PI);
		rc_ctx.font = "normal 8px sans-serif"; // small-caps 
		rc_ctx.fillText("100",140,123);		 
		rc_ctx.arc(150,150,(200/max_cs_distance)*140,0,2*Math.PI);
		rc_ctx.fillText("200",140,92);		 
		rc_ctx.arc(150,150,(300/max_cs_distance)*140,0,2*Math.PI);
		rc_ctx.fillText("300",140,60);		 
		rc_ctx.arc(150,150,(400/max_cs_distance)*140,0,2*Math.PI);
		rc_ctx.fillText("400",140,30);		 
		rc_ctx.closePath();
		rc_ctx.stroke();

	}
	var refreshCircularStatsInterval = setInterval(refreshCircularStats, stats_refresh_rate);
	initCircularStats();


</script>
</body>
</html>


